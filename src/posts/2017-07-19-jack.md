<!--
{
  "title": "Linux Audio (ALSA, Jack)",
  "date": "2017-07-19T10:12:14+09:00",
  "category": "",
  "tags": [],
  "draft": true
}
-->

# Building (Jack2 repo)

```
$ mkdir -p out/Debug
$ ./waf configure --out=out/Debug --debug # prepare python2 beforehand
$ ./waf build

(jackd)
$ LD_LIBRARY_PATH=$PWD/out/Debug/common JACK_DRIVER_DIR=$PWD/out/Debug ./out/Debug/jackd -d alsa

(client: audio out)
$ LD_LIBRARY_PATH=$PWD/out/Debug/common ./out/Debug/example-clients/jack_metro --bpm 60

(client: connect port)
$ LD_LIBRARY_PATH=$PWD/out/Debug/common ./out/Debug/example-clients/jack_connect metro:60_bpm system:playback_1

(client: midi out)
$ LD_LIBRARY_PATH=$PWD/out/Debug/common ./out/Debug/example-clients/jack_midisine

(client: midi in -> audio out)
$ LD_LIBRARY_PATH=$PWD/out/Debug/common ./out/Debug/example-clients/jack_midiseq Sequencer 24000 0 60 8000 12000 63 8000
```


# Overview

- jackd -> alsa
- audio-out client -> jackd
- midi-out client -> midi-in client
- alsa midi-in -> jackd
- threading (SCHED_FIFO for non-main threads)
- shared memory


## Jackd

```
[ Data structure ]
jackctl_server
'-* jackctl_driver
'-' JackServer
  '-' JackGraphManager (on shmem)
  '-' JackLockedEngine (< JackEngine)
  '-' JackThreadedDriver
    '-' JackPosixThread
    '-' JackAlsaDriver (< JackAudioDriver < JackDriver < JackDriverClientInterface)
      '-' alsa_driver_t (< jack_driver_nt_t < jack_driver_t)
        '-' snd_pcm_t *playback_handle, capture_handle
        '-' snd_ctl_t *ctl_handle ..
        '-' jack_hardware_t ?
      '-' ??
  '-' ??

jack_shm_header
'-' jack_shm_server_t

jack_shm_info_t (static registry_info)
'-' ptr (void *attached_at)

jack_shm_header_t (static jack_shm_header)
'-* jack_shm_server_t
  '-' pid, name

jack_shm_registry_t (static jack_shm_registry)
'-' pid_t allocator


[ Procedure ]

(Main thread)
- main =>
  - jackctl_server_t *server_ctl = jackctl_server_create =>
    - alloc struct jackctl_server*
    - jackctl_drivers_load =>
      - jack_drivers_load =>
        - look for "jack_xxx.so" under JACK_DRIVER_DIR and call "driver_get_descriptor".
          for example, driver_get_descriptor in linux/alsa/JackAlsaDriver.cpp =>
          - alloc jack_driver_desc_t* and setup parameters on it
      - alloc struct jackctl_driver*
    - jackctl_internals_load => ..
  - jackctl_driver_t * master_driver_ctl = jackctl_server_get_driver(server_ctl, "alsa")
  - jackctl_server_open(server_ctl, master_driver_ctl) =>
    - jack_register_server =>
      - jack_server_initialize_shm =>
        - jack_access_registry (&registry_info) =>
          - int shm_fd = shm_open("/jack-shm-registry" ..)
          - registry_info->ptr.attached_at = mmap(.. MAP_SHARED, shm_fd ..)
          - jack_shm_header = registry_info->ptr.attached_at
          - jack_shm_registry = jack_shm_header + 1
        - jack_shm_header->server[i].pid = GetPID()
    - server_ptr->engine = new JackServer =>
      - JackGraphManager::Allocate => JackShmMem::operator new and JackGraphManager
      - new JackEngineControl
      - new JackLockedEngine
      - new JackFreewheelDriver
      - new JackThreadedDriver
      - new JackDriverInfo
    - JackServer::Open(driver_ptr->desc_ptr ..) =>
      - JackMessageBuffer::Create =>
        - new JackMessageBuffer, Start => StartSync => JackPosixThread::StartImp ..
      - JackDriverInfo::Open =>
        - LoadDriverModule (aka dlopen) and GetDriverProc(.. "driver_initialize") (aka dlsym)
        - driver_initialize (JackAlsaDriver.cpp) =>
          - new Jack::JackAlsaDriver("system", "alsa_pcm" ..)
          - new Jack::JackThreadedDriver
          - JackAlsaDriver::Open =>
            - JackAudioDriver::Open => JackDriver::Open =>
              - JackLockedEngine::ClientInternalOpen => ??
              - JackGraphManager::DirectConnect => JackConnectionManager::DirectConnect ..
            - alsa_driver_new =>
              - alloc alsa_driver_t
              - jack_driver_nt_init => jack_driver_init
              - alsa_driver_check_card_type =>
                - snd_ctl_card_info_alloca
                - snd_ctl_open(.. "hw:0" ..)
                - snd_ctl_card_info and snd_ctl_card_info_get_driver (I got "HDA-Intel")
              - alsa_driver_hw_specific => jack_alsa_generic_hw_new => alloc jack_hardware_t
              - snd_pcm_open(&driver->playback_handle, "hw:0" ..) (If this fails, jack exits)
              - snd_pcm_nonblock(driver->playback_handle, 0)
              - snd_pcm_open(&driver->capture_handle, "hw:0" ..)
              - snd_pcm_nonblock(driver->capture_handle, 0)
              - snd_pcm_hw_params_malloc(driver->playback_hw_params) .. similar to capture and sw_paramas
              - alsa_driver_set_parameters =>
                - alsa_driver_configure_stream(.. driver->playback_handle ..) =>
                  - snd_pcm_hw_params_any, snd_pcm_hw_params_set_periods_integer ..
                - snd_pcm_hw_params_get_rate (driver->playback_hw_params ..)
                - snd_pcm_hw_params_get_period_size, get_format, get_access (driver->playback_hw_params ..)
                - snd_pcm_format_physical_width (driver->playback_sample_format)
                - snd_pcm_mmap_begin(driver->playback_handle, ..)
                - alsa_driver_setup_io_function_pointers =>
                  - driver->write_via_copy = sample_move_d32u24_sSs (aka float to 24 bit integer)
              - snd_pcm_link(driver->playback_handle, driver->capture_handle)
          - return threaded_driver
      - JackSocketServerChannel::Open =>
        - JackServerSockert::Bind => unix domain socket, bind, listen .. ("/dev/shm/jack_default_1000_0")
        - new JackRequestDecoder =>
      - JackLockedEngine::Open => JackEngine::Open =>
        - JackSocketServerNotifyChannel::Open => JackClientSocket::Connect => socket connect to above "jack_default_1000_0"
      - JackFreewheelDriver::Open => JackDriver::Open => JackLockedEngine::ClientInternalOpen ..
      - JackThreadedDriver::Attach => JackAlsaDriver::Attach =>
        - JackLockedEngine, JackEngine::PortRegister("system:capture_0" ..) =>
          - JackGraphManager::AllocatePort =>
            - GetPort, JackPort::Allocate => ..
            - JackConnectionManager::AddOutputPort => ..
          - NotifyPortRegistration => NotifyClients => ..
        - similar to "system:capture_1", "system:playback_0" and "system:playback_1"
      - SetClockSource => ..
  - jackctl_server_start => JackServer::Start =>
    - JackThreadedDriver::Start =>
      - JackAlsaDriver::Start =>
        - JackEngineControl::InitFrameTime =>
      - alsa_driver_start =>
        - snd_pcm_prepare(driver->playback_handle)
        - driver->playback_nfds = snd_pcm_poll_descriptors_count(driver->playback_handle)
        - driver->pfd = alloc pollfd
        - snd_pcm_uframes_t pavail = snd_pcm_avail_update
        - alsa_driver_get_channel_addresses => snd_pcm_mmap_begin
        - alsa_driver_silence_on_channel => ..
        - snd_pcm_mmap_commit
        - snd_pcm_start  
      - JackPosixThread::StartSync => ..
    - JackSocketServerChannel::Start => JackPosixThread::Start ..
  - jackctl_wait_signals => sigwait ..


(jackMessageBuffer thread)
- JackMessageBuffer::Execute => ??


(JackAlsaDriver thread)
- JackThreadedDriver::Execute => Process => JackAudioDriver::Process => ProcessAsync =>
  - JackAlsaDriver::Read =>
    - alsa_driver_wait =>
      - snd_pcm_poll_descriptors(driver->playback_handle ..)
      - poll
      - ??
    - ??
  - JackAlsaDriver::Write =>
    - ??


(JackSocketServer thread)
- JackSockerServerChannel::Execute => ??
```


## Jack Client

- metro.c

```
(main thread)
- main => TODO

(jack thread: callback execution)
- TODO
```


# ALSA Client

```
(test program from http://git.alsa-project.org/?p=alsa-lib.git;a=summary)
$ ./test/pcm --device 'hw:0' --channels 2 -v
Playback device is hw:0
Stream parameters are 44100Hz, S16_LE, 2 channels
Sine wave rate is 440.0000Hz
Using transfer method: write
Hardware PCM card 0 'HDA Intel PCH' device 0 subdevice 0
Its setup is:
  stream       : PLAYBACK
  access       : RW_INTERLEAVED
  format       : S16_LE
  subformat    : STD
  channels     : 2
  rate         : 44100
  exact rate   : 44100 (44100/1)
  msbits       : 16
  buffer_size  : 22050
  period_size  : 4410
  period_time  : 100000
  tstamp_mode  : NONE
  tstamp_type  : MONOTONIC
  period_step  : 1
  avail_min    : 4410
  period_event : 0
  start_threshold  : 22050
  stop_threshold   : 22050
  silence_threshold: 0
  silence_size : 0
  boundary     : 6206523236469964800
  appl_ptr     : 0
  hw_ptr       : 0
```


# TODO

- Jack
  - http://jackaudio.org/
  - https://github.com/jackaudio/jack2
- Kernel
  - sched(7) (SCHED_FIFO)
  - mlock(2)
  - shm_overview(7)
  - ALSA http://git.alsa-project.org/
