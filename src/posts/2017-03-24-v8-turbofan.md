<!--
{
  "title": "V8: Compiling Javascript",
  "date": "2017-03-25T01:54:33+09:00",
  "category": "",
  "tags": ["javascript", "source"],
  "draft": true
}
-->

# Following samples/shell.cc

```
[ Basic Steps ]
- platform::CreateDefaultPlatform => this spawns 3 WorkerThread s
- InitializePlatform(platform)
- Isolate::New
- (block)
  - Isolate::Scope isolate_scope
  - HandleScope handle_scope
  - (Local) v8::Context::New
  - Context::Scope context_scope
  - (loop for)
    - HandleScope handle_scope
    - (Local) Isolate::GetCurrentContext
    - (Local) Script
    - Script::Compile
    - Script::Run
    - platform::PumpMessageLoop

[ Compilation ]
- Script::Compile => ScriptCompiler::Compile =>
  - CompileUnboundInternal =>
    - Compiler::GetSharedFunctionInfoForScript (with NON_NATIVES_CODE)
      - Factory::NewScript
      - set Script::Typescript (e.g. TYPE_NATIVE)
      - prepare ParseInfo, Zone, CompilationInfo
      - CompileToplevel =>
        - ?
    - return UnboundScript with SharedFunctionInfo
  - UnboundScript::BindToCurrentContext =>
    - cast to SharedFunctionInfo
    - Factory::NewFunctionFromSharedFunctionInfo =>
      - NewFunction
      - (returns JSFunction)

[ Linking (?) and Execution ]
- Script::Run => Execution::Call => CallInternal => Invoke =>
  - code = Factory::js_entry_code (relavant macros ROOT_ACCESSOR, ROOT_LIST, STRONG_ROOT_LIST)
  - JSEntryFunction stub_entry = Code::entry
  - CALL_GENERATED_CODE (which actually calls stub_entry as normal C function)
    - cannot track debug symbol ??

[ Data Structure ]
[[ v8 api ]]
Platform
Isolate
Context
Context::Scope
HandleScope
Value
Local<T>
MaybeLocal
ScriptCompiler, Compiler
Source
UnboundScript, Script

[[ internal ]]
VMState
SharedFunctionInfo
Script
Code
Context
```


# Example

I experimented v8 with this classic example:

```
// fib.js

function fib0(n) {
  if (n <= 1) {
    return n;
  } else {
    return fib0(n - 1) + fib0(n - 2);
  }
}

function fib1(n) {
  var arr = [0, 1];
  for(var i = 2; i <= n; i++) {
    arr.push(arr[i - 1] + arr[i - 2]);
  }
  return arr[n];
}

function main() {
  print(fib0(10)); // => 55
  print(fib1(10)); // => 55
}

main();
```

```
$ ./out.gn/x64.debug/v8_shell fib.js
55
55
```


# TODO

- follow stub entry
- follow code generation and generated code
- understand basic C++ techniques
  - dynamic casting
      - FUNCTION_CAST
      - reinterpret_cast
  - macro
- my concerns
  - JIT
      - compilation unit
      - jit call unit
      - dynamic link and jump to JITed code
      - internal representation of ELF ?
  - MessageLoop
      - v8::platform::PumpMessageLoop ?
  - (internal) Threads
  - GC
  - Bridging C++
      - GC concern
  - String representation (UTF8)


# References

- Spec: http://www.ecma-international.org/ecma-262/7.0/index.html
- https://github.com/v8/v8/wiki/TurboFan

  - [Turbofan IR](https://docs.google.com/presentation/d/1Z9iIHojKDrXvZ27gRX51UxHD-bKf1QcPzSijntpMJBM/edit#slide=id.p)
  - [An overview of the TurboFan compiler](https://docs.google.com/presentation/d/1H1lLsbclvzyOF3IUR05ZUaZcqDxo7_-8f4yJoxdMooU/edit#slide=id.p)
  - [Turbofan JIT design](https://docs.google.com/presentation/d/1sOEF4MlF7LeO7uq-uThJSulJlTh--wgLeaVibsbb3tc/edit#slide=id.p)

