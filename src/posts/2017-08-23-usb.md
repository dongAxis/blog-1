<!--
{
  "title": "USB",
  "date": "2017-08-23T21:47:50+09:00",
  "category": "",
  "tags": [],
  "draft": true
}
-->

# TODO

- libusb, lsusb (udev or sysfs ?)
- usb concenpts
  - host controller
  - device
  - device function
  - pipe, endpoint
  - interface
  - class
  - transfer (??)
  - descriptor (TODO: follow SETUP packat transaction)
- kernel
  - usb host subsystem
  - usb driver example
  - usb device side of subsystem (as used in embedded or android ?)
- examples
  - MIDI device
  - Sound card (aka Audio interface)
    - how usb layer enumerates alsa device
  - usb drive (block device)
  - btusb
  - usb to ethernet
  - android phone as usb device
  - hub driver
- electrically
  - differential signalling on a twisted-pair
  - NRZI encoding
  - bit stuffing
  - packet protocol
- constrast to other protocol (bluetooth for example ?)


# Overview

- Device information via sysfs

```
$ lsusb.py -ceI # c: color output, e: show endpoint info (EP), I: show interface info (IF)
usb1             1d6b:0002 09  2.00  480MBit/s 0mA 1IF  (Linux 4.11.9-1-ARCH xhci-hcd xHCI Host Controller 0000:00:14.0)
                   (EP) 00: Control  attr 00 len 07 max 040
 1-0:1.0          (IF) 09:00:00 1EP  (Hub::Full speed (or root) hub) hub
                   (EP) 81: Interrupt (256ms) attr 03 len 07 max 004
 1-7             8087:0a2a e0  2.00   12MBit/s 100mA 2IFs (Intel Corp.)
                   (EP) 00: Control  attr 00 len 07 max 040
  1-7:1.0         (IF) e0:01:01 3EPs (Wireless:Radio Frequency:Bluetooth) btusb bluetooth/hci0
                   (EP) 02: Bulk (0ms) attr 02 len 07 max 040
                   (EP) 81: Interrupt (1ms) attr 03 len 07 max 040
                   (EP) 82: Bulk (0ms) attr 02 len 07 max 040
  1-7:1.1         (IF) e0:01:01 2EPs (Wireless:Radio Frequency:Bluetooth) btusb
                   (EP) 83: Isoc (1ms) attr 01 len 07 max 000
                   (EP) 03: Isoc (1ms) attr 01 len 07 max 000
 1-3             04f2:b569 ef  2.00  480MBit/s 500mA 2IFs (Chicony Electronics Co.,Ltd. Integrated Camera 0001)
                   (EP) 00: Control  attr 00 len 07 max 040
  1-3:1.0         (IF) 0e:01:00 1EP  (Video:Video Control) uvcvideo video4linux/video0 input/input10
                   (EP) 83: Interrupt (4ms) attr 03 len 07 max 010
  1-3:1.1         (IF) 0e:02:00 0EPs (Video:Video Streaming) uvcvideo
 1-2             0bda:5411 09  2.10  480MBit/s 100mA 1IF  (Realtek Semiconductor Corp.)
                   (EP) 00: Control  attr 00 len 07 max 040
  1-2:1.0         (IF) 09:00:02 1EP  (Hub::TT per port) hub
                   (EP) 81: Interrupt (256ms) attr 03 len 07 max 001
usb2             1d6b:0003 09  3.00 5000MBit/s 0mA 1IF  (Linux 4.11.9-1-ARCH xhci-hcd xHCI Host Controller 0000:00:14.0)
                   (EP) 00: Control  attr 00 len 07 max 040
 2-0:1.0          (IF) 09:00:00 1EP  (Hub::Full speed (or root) hub) hub
                   (EP) 81: Interrupt (12ms) attr 03 len 07 max 004
 2-3             0bda:0411 09  3.00 5000MBit/s 96mA 1IF  (Realtek Semiconductor Corp.)
                   (EP) 00: Control  attr 00 len 07 max 200
  2-3:1.0         (IF) 09:00:00 1EP  (Hub::Full speed (or root) hub) hub
                   (EP) 81: Interrupt (8ms) attr 13 len 07 max 002


[ Meaning of each field ]

<host-controller>
  <>-<>          <vendor-id>:<producti-id>  <interface-class> <usb-version> ..
                   (EP) <endpoint-address>: <transfer-type> <interval> ...
    <>-<>:<>.<>   (IF) <interface-class>:<interface-sub-class>:<interface-protocol> <protocol-name> <device-driver> <??>
                    (EP) ...
```

- Device enumeration
  - host controller initialization (xhci)
  - SETUP packet transaction
  - Reading descriptor
  - interface class identification and loading specific module
    - examples: hub class (0x09), audio class (0x01)


- Interaction with other subsystem
  - ALSA
  - Bluetooth
  - Ethernet
  - Block device

# USB Basics

Summery of

- [USB_3_1_r1.0.pdf](http://www.usb.org/developers/docs/)
- and wiki https://en.wikipedia.org/wiki/USB


# USB Audio class

Summery of [Audio Device Document 1.0](http://www.usb.org/developers/docs/devclass_docs/audio10.pdf):

- 3 Overview
    - class, subclass, and protocol
        - Audio interface class: 0x01
        - AudioControl interface subclass: 0x01
        - AudioStreaming interface subclass: 0x02
        - MidiStreaming interface subclass: 0x03
        - protocol: 0x00 (unused)
    - function
        - aka some assumed set of "components" in audio device
        - input/output terminal
        - mixer/selector/feature/processing/extension unit
    - interface and endpoint
        - AudioControl interface
            - control endpoint (0)
            - status interrupt endpoint
        - AudioStreaming interface
            - isochronous audio data stream endpoint
            - isochronous synch endpoint
        - MidiStreaming (in a different document)
- 4 Descriptor
  - device descriptor (no audio class specific)
  - configuration descriptor (no audio class specific)
  - AudioControl interface
      - header part: bInCollection (number of AudioStreaming or MidiStreaming interfaces)
      - input/output terminal part
          - bTerminalID
          - wTerminalType (could be IN/OUT endpoint, external line-in/out, speaker etc...)
  - AudioControl endpoint (no audio class specific)
  - AudioControl interrupt endpoint (no audio class specific)
  - AudioStreaming interface
      - bTerminalLink (Terminal ID which this interface's endpoint is connected to)
      - wFormatTag
  - AudioStreaming isochronous audio data Endpoint
      - bmAttributes (represent what kind of parameter can be controlled e.g. sample frequency)
- 5 Request
  - some class specific requests regarding controllability
  - (not essential in terms of transporting audio data)


# Kernel

- TODO
  - basic transaction with usb device
  - IN, OUT, SETUP ..

```
- drivers/usb/
  - README
  - host/
  - gadget/
  - core/
    - driver.c
- sound/
  - core/...
  - usb/
    - card.c
    - midi.c
    - ...
```


# Referecnes

- Spec
  - http://www.usb.org/developers/docs/ (as of writing, USB_3_1_r1.0.pdf was available.)
  - http://www.usb.org/developers/docs/devclass_docs/
- Kernel http://www.linux-usb.org/
- Userspace http://libusb.info/
- Wiki https://en.wikipedia.org/wiki/USB
- Hardware
  - xhci: https://www.intel.com/content/dam/www/public/us/en/documents/technical-specifications/extensible-host-controler-interface-usb-xhci.pdf
