<!--
{
  "title": "V8 Garbage Collection",
  "date": "2017-04-15T12:09:10+09:00",
  "category": "",
  "tags": ["v8", "javascript", "source", "gc"],
  "draft": true
}
-->

Assumes things I've written in [v8-ignition-turbofan](./2017-03-24-v8-ignition-turbofan.html).

# Basic steps

```
[ Initialization ]
- Isolate::Init =>
  - Heap::Setup =>
    - ConfigureHeapDefault
    - InitializeGCOnce =>
    - new MemoryAllocator, StoreBuffer, IncrementalMarking, ConcurrentMarking
    - new NewSpace, OldSpace (for object) , OldSpace (for executable code), MapSpace + SetUp
    - new Scavenger, MarkCompactCollector

- InitializeGCOnce =>
  - Scavenger::Initialize =>
  - StaticScavengeVisitor::Initialize =>
  - MarkCompactCollector::Initialize =>


[ Allocation via GC system]
(externally)
- v8::Object::New =>
  - Factory::NewJSObject =>
    - CALL_HEAP_FUNCTION =>
      - Heap::AllocateJSObject (return allocation (Object*)) =>
        - AllocateJSObjectFromMap =>
          - SelectSpace (check PretenureFlag, here assume it's NOT_TENURED, then selects NEW_SPACE)
          - Allocate (from existing Map) =>
            - AllocateRaw =>
              - (assume allocate to NEW_SPACE)
              - NewSpace::AllocateRaw => AllocateRawUnaligned =>
                - HeapObject::FromAddress(AllocationInfo::top) (return address top + kHeapObjectTag)
                - AllocationInfo::set_top (extends heap by size_in_bytes)
            - HeapObject::set_map_no_write_barrier =>
              - MapWord::FromMap
              - set_map_word =>
                - NOBARRIER_WRITE_FIELD(... kMapOffset, map_word.value_) =>
                  - FIELD_ADDR(...kMapOffset) (which is HeapObject's `this` pointer + offset - kHeapObjectTag)
          - InitializeJSObjectFromMap => (forget now)
      - (if allocation failed, Heap::CollectGarbage and retry)
      - RETURN_OBJECT_UNLESS_RETRY =>
        - Handle<JSObject>(JSObject::cast(...)) =>
          - location_ = HandleScope::GetHandle (returns Object**) =>
            - Isolate::handle_scope_data::canonical_scope
            - (CanonicalHandleScope::lookup or CreateHandle)
            - CanonicalHandleScope::lookup => ?
            - CreateHandle =>
              - assign allocated (Heap)Object's pointer to current HandleScopeData::next
              - increment HandleScopeData::next
              - (possibly Extend)
              - return the pointer to the handle (Object**)


[ Heap Object memory layout in heap ]

                 top --------------------
top + kHeapObjectTag -------------------- ( HeapObject's `this` points to here for GC purpose,
                                            but XXX_WRITE_FIELD (and FIELD_ADDR) subtracts it to use memory from top)
 top + size_in_bytes --------------------


[ Data structure ]
Isolate
'-' HandleScopeData
  '-' CanonicalHandleScope
'-' HandleScopeImplementer

Handle (extends HandleBase)
'-' _location (keep pointer to heap object, which means its type is **Object)

Q. what's the scenerio of having a nested HandleScope ?
Q. what are these HandleScope variants ? (e.g. CanonicalHandleScope, DeferredHandleScope, SealHandleScope)
```


# Garbage collections

## Entrypoint

```
Q. Garbage collection entrypoint (GarbageCollectionReason)?
  - CALL_HEAP_FUNCTION => kAllocationFailure
  - ? kMemoryPressure
  - SCAVENGER
    - blink idle task ? (kIdleTask)
    - copying
    - aging evacuation
  - MARK_COMPACTOR
    - marking <= some interrupt ?
      - incremental
    - sweep and compact <= memory pressure ?
  - Some contract between ObjectSpace and AllocationSpace
```


## Copying

```
[ Copying ]
(assume coming here from CALL_HEAP_FUNCTION)
- Heap::CollectGarbage() =>
- Heap::CollectGarbage =>
  - Heap::Scavenge


[ Example ]
(gc.js)
var x = new Object;
for (var i = 0; i < 20000; i++) {
  x.p = new Object;
  x = x.p;
}
// Object -> Object -> Object -> Object ... -> Object
//                                             ^^^^^x

(tracing)
$ ./out.gn/x64.debug/v8_shell --trace_gc --trace_gc_verbose gc.js
[23095:0x55cc8cc25e40] Shrinking page 0x1a0a91480000: end 0x1a0a91500000 -> 0x1a0a914d2000
[23095:0x55cc8cc25e40] Shrinking page 0x26c170800000: end 0x26c17087f000 -> 0x26c17087e000
[23095:0x55cc8cc25e40] Shrinking page 0x26c170980000: end 0x26c1709ff000 -> 0x26c1709e6000
[23095:0x55cc8cc25e40] Shrinking page 0x36bf8e600000: end 0x36bf8e680000 -> 0x36bf8e605000
[23095:0x55cc8cc25e40] Fast promotion mode: false survival rate: 44%
[23095:0x55cc8cc25e40]       35 ms: Scavenge 3.8 (7.5) -> 3.3 (8.5) MB, 17.9 / 0.0 ms  allocation failure
[23095:0x55cc8cc25e40] Memory allocator,   used:   8704 KB, available: 1457664 KB
[23095:0x55cc8cc25e40] New space,          used:    448 KB, available:    558 KB, committed:   2048 KB
[23095:0x55cc8cc25e40] Old space,          used:    988 KB, available:      0 KB, committed:   1352 KB
[23095:0x55cc8cc25e40] Code space,         used:   1857 KB, available:      0 KB, committed:   2456KB
[23095:0x55cc8cc25e40] Map space,          used:     55 KB, available:      0 KB, committed:    532 KB
[23095:0x55cc8cc25e40] Large object space, used:      0 KB, available: 1457143 KB, committed:      0 KB
[23095:0x55cc8cc25e40] All spaces,         used:   3349 KB, available: 1457702 KB, committed:   6388KB
[23095:0x55cc8cc25e40] External memory reported:      0 KB
[23095:0x55cc8cc25e40] Total time spent in GC  : 17.9 ms
[23095:0x55cc8cc25e40] Fast promotion mode: false survival rate: 2%
[23095:0x55cc8cc25e40]       62 ms: Scavenge 3.8 (8.5) -> 2.9 (8.5) MB, 1.6 / 0.0 ms  allocation failure
[23095:0x55cc8cc25e40] Memory allocator,   used:   8704 KB, available: 1457664 KB
[23095:0x55cc8cc25e40] New space,          used:      0 KB, available:   1006 KB, committed:   2048 KB
[23095:0x55cc8cc25e40] Old space,          used:   1011 KB, available:      0 KB, committed:   1352 KB
[23095:0x55cc8cc25e40] Code space,         used:   1860 KB, available:      0 KB, committed:   2456KB
[23095:0x55cc8cc25e40] Map space,          used:     55 KB, available:      0 KB, committed:    532 KB
[23095:0x55cc8cc25e40] Large object space, used:      0 KB, available: 1457143 KB, committed:      0 KB
[23095:0x55cc8cc25e40] All spaces,         used:   2926 KB, available: 1458150 KB, committed:   6388KB
[23095:0x55cc8cc25e40] External memory reported:      0 KB
[23095:0x55cc8cc25e40] Total time spent in GC  : 19.5 ms
```

## Generational

```
[ Generational ]
- Heap::EvacuateYoungGeneration
```


## Mark, Sweep, and Compact

```
- IncrementalMarking::Start
- ConcurrentMarking::Task (not used yet?)
- MarkCompactCollector::CollectGarbage =>
  - MarkLiveObjects
  - StartSweepSpaces
- MarkCompactCollector::StartCompaction
```
